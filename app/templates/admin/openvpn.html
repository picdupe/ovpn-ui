{% extends "base.html" %}

{% block title %}OpenVPN 配置 - OpenVPN WebUI{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2>OpenVPN 配置</h2>
            
            <!-- 服务状态卡片 -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">服务状态</h5>
                        </div>
                        <div class="card-body">
                            <div id="openvpn-status">
                                <p>正在检查服务状态...</p>
                            </div>
                            <button id="restart-openvpn" class="btn btn-warning mt-2" disabled>
                                重启 OpenVPN 服务
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">连接统计</h5>
                        </div>
                        <div class="card-body">
                            <div id="connection-stats">
                                <p>正在获取连接信息...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 服务器配置 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">服务器配置</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        服务器配置文件位于: /etc/ovpn-ui/openvpn/server.conf
                    </div>
                    <div class="mt-3">
                        <a href="/api/openvpn/config/download" class="btn btn-outline-primary">
                            下载服务器配置
                        </a>
                        <button class="btn btn-outline-secondary" onclick="showConfigInfo()">
                            查看配置信息
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 获取OpenVPN状态
function loadOpenVPNStatus() {
    fetch('/api/openvpn/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('openvpn-status');
            const restartBtn = document.getElementById('restart-openvpn');
            
            if (data.success) {
                let statusClass = data.status === 'active' ? 'text-success' : 'text-danger';
                let statusText = data.status === 'active' ? '运行中' : '已停止';
                
                statusDiv.innerHTML = `
                    <p><strong>服务状态:</strong> <span class="${statusClass}">${statusText}</span></p>
                    <p><strong>连接客户端:</strong> ${data.connected_clients}</p>
                    <p><strong>服务器运行:</strong> ${data.server_running ? '是' : '否'}</p>
                `;
                
                restartBtn.disabled = false;
            } else {
                statusDiv.innerHTML = `<p class="text-danger">获取状态失败: ${data.error}</p>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('openvpn-status').innerHTML = 
                '<p class="text-danger">获取状态时发生错误</p>';
        });
}

// 重启OpenVPN服务
document.getElementById('restart-openvpn').addEventListener('click', function() {
    if (!confirm('确定要重启OpenVPN服务吗？这可能会中断现有连接。')) {
        return;
    }
    
    this.disabled = true;
    this.textContent = '重启中...';
    
    fetch('/api/openvpn/restart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('OpenVPN服务重启成功');
            loadOpenVPNStatus(); // 重新加载状态
        } else {
            alert('重启失败: ' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        alert('重启请求失败: ' + error);
    })
    .finally(() => {
        this.disabled = false;
        this.textContent = '重启 OpenVPN 服务';
    });
});

// 显示配置信息
function showConfigInfo() {
    alert('服务器配置信息:\n\n' +
          '配置文件: /etc/ovpn-ui/openvpn/server.conf\n' +
          '客户端配置模板: /usr/local/ovpn-ui/config/openvpn/common-client.ovpn\n' +
          '认证文件: /etc/ovpn-ui/openvpn/auth/users\n' +
          'CCD目录: /etc/ovpn-ui/openvpn/ccd/');
}

// 页面加载时获取状态
document.addEventListener('DOMContentLoaded', function() {
    loadOpenVPNStatus();
    
    // 每30秒自动更新状态
    setInterval(loadOpenVPNStatus, 30000);
});
</script>
{% endblock %}